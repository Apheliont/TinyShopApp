@using TinyShop.Shared.Layouts
@layout ProductsLayout
@page "/categories/{categoryId:int}/products"
@inject IProductSqlDataService dataService
@using System.Text;
@using TinyShop.Extensions
@using TinyShop.Helpers
@using TinyShop.Pages.Products.ProductFilter
@using DataAccessLib.Enums
@inject NavigationManager NavigationManager
@inject IPurchaseSqlDataService purchaseDataService
@inject IUserUtilities userUtilities
@inject IStringLocalizer<App> Localizer
@implements IDisposable

<div class="ui grid">
    <div class="row">
        <div class="four wide column">
        </div>
        <div class="twelve wide column">
            <SortPannelComponent MetadataModel="@ProductsWithMetadata.Metadata"
                                 FilterModel="@FilterModel"
                                 OnSortChange="OnSortChangeHandler" />
        </div>
    </div>
    <div class="row">
        <div class="four wide column">
            <CategoryMenu AccordionCssString="categories-menu" />
            <ProductFilterComponent FilterModel="@FilterModel"
                                    OnApplyFilter="ApplyFilterHandler"
                                    OnResetFilter="ResetFilterHandler" />
        </div>
        <div class="twelve wide column">
            <ProductListComponent Products="@ProductsWithMetadata.Products" OnAddToCart="AddToCartHandler" />
            <Paginator NumberOfPages="@numberOfPages" CurrentPage="@FilterModel.PageNumber" OnPageChanged="PageHasChanged" />
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int CategoryId { get; set; }

    public ProductsWithMetadataModel ProductsWithMetadata { get; set; }

    public ProductFilterModel FilterModel { get; set; }

    private int numberOfPages;

    protected override void OnParametersSet()
    {
        InitFilterModel();
        InitializeData();
    }


    private void InitializeData()
    {
        GetQueryStringValues();

        ProductsWithMetadata = dataService.GetFilteredWithMetadata(FilterModel);

        if (ProductsWithMetadata is not null)
        {
            // TODO: Fix this shit!
            FilterModel.Price.LowerBound = ProductsWithMetadata.Metadata.Price.LowerBound;
            FilterModel.Price.UpperBound = ProductsWithMetadata.Metadata.Price.UpperBound;
            FilterModel.Price.Measurement = ProductsWithMetadata.Metadata.Price.Measurement;

            if (ProductsWithMetadata.Metadata.Details is not null)
            {
                FilterModel.DetailsFilterModel = MetadataUtils.CreateDetailsFilter(ProductsWithMetadata.Metadata.Details);
            }
            numberOfPages = (int)(Math.Ceiling((double)ProductsWithMetadata.Metadata.FoundRecords / (int)FilterModel.RowsPerPage));
        }

    }

    private void InitFilterModel()
    {
        FilterModel = new ProductFilterModel
        {
            CategoryId = CategoryId,
        };
    }


    void GetQueryStringValues()
    {
        if (NavigationManager.TryGetQueryString<int>("page", out int pageNumber))
        {
            FilterModel.PageNumber = pageNumber;
        }
        if (NavigationManager.TryGetQueryString<int>("minPrice", out int minPrice))
        {
            FilterModel.Price.From = minPrice;
        }
        if (NavigationManager.TryGetQueryString<int>("maxPrice", out int maxPrice))
        {
            FilterModel.Price.To = maxPrice;
        }
        if (NavigationManager.TryGetQueryString<int>("orderBy", out int orderBy))
        {
            if (Enum.IsDefined(typeof(OrderByEnum), orderBy))
            {
                FilterModel.OrderBy = (OrderByEnum)orderBy;
            }
        }
        if (NavigationManager.TryGetQueryString<int>("sortOrder", out int sortOrder))
        {
            if (Enum.IsDefined(typeof(SortOrderEnum), sortOrder))
            {
                FilterModel.SortOrder = (SortOrderEnum)sortOrder;
            }
        }
        if (NavigationManager.TryGetQueryString<int>("rowsPerPage", out int rowsPerPage))
        {
            if (Enum.IsDefined(typeof(RowsPerPageEnum), rowsPerPage))
            {
                FilterModel.RowsPerPage = (RowsPerPageEnum)rowsPerPage;
            }
        }
        if (NavigationManager.TryGetQueryString<int>("minRating", out int minRating))
        {
            FilterModel.Rating.CurrentRating = minRating;
        }
    }

    protected override void OnInitialized()
    {
        NavigationManager.LocationChanged += HandleLocationChanged;
    }

    private void HandleLocationChanged(object sender, LocationChangedEventArgs e)
    {
        InitializeData();
        StateHasChanged();
    }

    private async Task AddToCartHandler(int productId)
    {
        string userId = await userUtilities.GetLoggedInUserId();
        if (userId is not null)
        {
            await purchaseDataService.AddToCart(userId, productId, 1);
        }
    }

    void IDisposable.Dispose()
    {
        NavigationManager.LocationChanged -= HandleLocationChanged;
    }

    private void PageHasChanged(int page)
    {
        StringBuilder sb = new StringBuilder();
        sb.Append($"/categories/{CategoryId}/products?");
        sb.Append($"page={page}");
        if (FilterModel.Price is not null)
        {
            sb.Append($"&minPrice={FilterModel.Price.From}");
        }
        if (FilterModel.Price is not null)
        {
            sb.Append($"&maxPrice={FilterModel.Price.To}");
        }
        sb.Append($"&orderBy={(int)FilterModel.OrderBy}");
        sb.Append($"&sortOrder={(int)FilterModel.SortOrder}");
        sb.Append($"&rowsPerPage={(int)FilterModel.RowsPerPage}");
        if (FilterModel.Rating.CurrentRating != 0)
        {
            sb.Append($"&minRating={FilterModel.Rating.CurrentRating}");
        }

        NavigationManager.NavigateTo(sb.ToString());
    }

    private void ApplyFilterHandler()
    {
        // Если был применен фильтр то переходим на 1ю страницу
        FilterModel.PageNumber = 1;
        PageHasChanged(FilterModel.PageNumber);
    }

    private void ResetFilterHandler()
    {
        InitFilterModel();
        PageHasChanged(FilterModel.PageNumber);
    }

    private void OnSortChangeHandler()
    {
        FilterModel.PageNumber = 1;
        PageHasChanged(FilterModel.PageNumber);
    }
}