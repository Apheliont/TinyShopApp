@page "/cart"
@inject IUserUtilities userUtilities
@inject IStringLocalizer<App> Localizer
@inject IPurchaseDataService purchaseDataService
@inject AppState AppState

@if (purchases is not null)
{
    @if (purchases.Any())
    {
        <table class="ui fixed single line compact celled definition table">
            <thead class="full-width">
                <tr>
                    <th>@Localizer["Product name"]</th>
                    <th>@Localizer["Price"]</th>
                    <th>@Localizer["Quantity"]</th>
                    <th style="text-align: center">@Localizer["Cost"]</th>
                    <th style="text-align: center">@Localizer["Action"]</th>
                </tr>
            </thead>
            <tbody>
                @foreach (PurchaseModel purchase in purchases)
                {
                    <tr>
                        <td><span class="text-regular">@purchase.ProductName</span></td>
                        <td>@Math.Round(purchase.Price, 2)</td>
                        <td style="text-align: center">
                            <div class="ui input focus">
                                <input type="number"
                           min="1"
                           value="@purchase.Quantity"
                           @onchange="async (args) => { await ChangeQuantityHandler(purchase.Id, args); }">
                            </div>
                        </td>
                        <td style="text-align: center">
                            @Math.Round(purchase.Price * purchase.Quantity, 2)
                        </td>
                        <td style="text-align: center">
                            <i class="trash icon" style="cursor: pointer" @onclick="async () => { await DeletePurchaseHandler(purchase.Id); }"></i>
                        </td>
                    </tr>
                }
            </tbody>
            <tfoot class="full-width">
                <tr>
                    <th>
                        <span class="text-bold">@Localizer["Total"]:</span>
                    </th>
                    <th>
                        <span class="text-bold">@totalPrice</span>
                    </th>
                    <th colspan="3">
                        <div class="ui right floated small primary button">
                            @Localizer["Buy"]
                        </div>
                    </th>
                </tr>
            </tfoot>
        </table>
    }
}

@code {
    private List<PurchaseModel> purchases;
    private decimal totalPrice => Math.Round(purchases.Sum(prod => prod.Price * prod.Quantity), 2);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // We have to get purchases exactly here but not during init phase
            // becouse GetAll method also uses access to localStorage which in its turn
            // only available after render
            purchases = await purchaseDataService.GetAll();
            StateHasChanged();
        }
    }

    private async Task DeletePurchaseHandler(int purchaseId)
    {
        if (await purchaseDataService.Delete(purchaseId))
        {
            if (purchases.Remove(purchases.Where(p => p.Id == purchaseId).FirstOrDefault()))
            {
                AppState.NotifyCartItemsCountChange();
            }
        }
    }

    private async Task ChangeQuantityHandler(int purchaseId, ChangeEventArgs args)
    {
        if (Int32.TryParse(args.Value.ToString(), out int q))
        {
            if (await purchaseDataService.Update(purchaseId, q))
            {
                PurchaseModel purchase = purchases.Find(p => p.Id == purchaseId);
                if (purchase is not null)
                {
                    purchase.Quantity = q;
                    AppState.NotifyCartItemsCountChange();
                }
            }
        }
    }
}
