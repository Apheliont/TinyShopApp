@inject ICategorySqlDataService categoryDataAccess
@using TinyShop.Helpers
@inject ILocalStorage LocalStorage
@inject IStringLocalizer<App> Localizer
@inject NavigationManager NavigationManager

<div class="@AccordionCssString">
    <div class="title">
        <i class="bars icon"></i>
        @Localizer["Categories"]
    </div>
    <div class="@openedMenuCssString">
        <div class="ui secondary vertical fluid menu">
            @if (categories is not null)
            {
                @foreach (CategoryModel category in categories)
                {
                    <NavLink class="item" Match="NavLinkMatch.All" @onclick="async () => await ChangeCategoryHandler(category)">
                        @if (category.Image is not null)
                        {
                            var categoryImageUrl = category.Image.UriSizeS is not null ? category.Image.UriSizeS : category.Image.UriSizeM;
                            <img class="category-menu__image" src="@categoryImageUrl" width="30" height="30" alt="@category.Image.Caption">
                        }
                        else
                        {
                            <div class="category-menu__no-image-placeholder"></div>
                        }
                        @category.CategoryName
                    </NavLink>
                }
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public bool IsMenuOpened { get; set; } = false;

    private string openedMenuCssString;

    private string accordionCssString = "ui styled accordion";

    [Parameter]
    public string AccordionCssString
    {
        get => accordionCssString; set
        {
            if (!String.IsNullOrEmpty(value))
            {
                accordionCssString += $" {value}";
            }
        }
    }


    private async Task ChangeCategoryHandler(CategoryModel category)
    {
        var url = $"categories/{category.Id.ToString()}";
        if (!category.IsParent)
        {
            string parameters = await LocalStorage.ReadSortingParameters();
            if (parameters.Length > 0)
            {
                url += $"/products?{parameters}";
            }
            else
            {
                url += "/products";
            }
        }
        NavigationManager.NavigateTo(url);
    }

    protected override void OnParametersSet()
    {
        openedMenuCssString = IsMenuOpened ? "active content" : "content";
    }

    private List<CategoryModel> categories;

    protected override async Task OnInitializedAsync()
    {
        categories = await categoryDataAccess.GetRoot();
    }
}
